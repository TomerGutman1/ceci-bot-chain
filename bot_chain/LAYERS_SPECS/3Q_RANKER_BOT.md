## מפרט מפורט – 3Q_RANKER_BOT

("Result Ranker" — שלב 3Q במסלול QUERY)

| קטגוריה                  | פרטים                                                                                                                                                                                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ייעוד עסקי**           | לדרג עד כ־50 תוצאות שהתקבלו מה־SQL לפי מידת הרלוונטיות לשאילתת המשתמש, כך שההחלטות המשמעותיות והמתאימות ביותר יופיעו ראשונות — לצורך שיפור חוויית המשתמש והדיוק. |
| **קלט נכנס**             | **מקור:** `SQL DB` דרך `2Q_SQL_GEN_BOT`  
                           **פורמט:** JSON  
                           ```json
                           {
                             "clean_query": "הבא לי החלטות…",
                             "rows": [
                               {
                                 "id": 345,
                                 "decision_title": "…",
                                 "summary": "…",
                                 "tags_policy_area": "…",
                                 "decision_date": "2024-07-25"
                               },
                               ...
                             ]
                           }
                           ```  
                           **שדות מותרים:** `id`, `decision_title`, `summary`, `tags_policy_area`, `decision_date` |
| **פלט יוצא**             | **יעד:** `4_FORMATTER`  
                           **פורמט:**  
                           ```json
                           { "ranked_ids": [345, 292, 267, …] }
                           ```  
                           עד `limit` שהוגדר (ברירת מחדל: 10) |
| **תחומי אחריות (Do)**   | - חישוב ציון רלוונטיות לכל שורה על בסיס `clean_query`  
                           - שילוב התאמה סמנטית (LLM) עם חוקים מוגדרים (לדוגמה: נושא, שנה, עדכניות)  
                           - החזרת מזהי החלטות ממויינים לפי סדר עדיפות בלבד |
| **גבולות (Don’t)**      | - לא משנה או מרחיב את השאלה המקורית  
                           - לא ניגש למסד הנתונים  
                           - לא מחזיר טקסט או תוכן למשתמש |
| **מודל GPT מומלץ**       | `gpt-3.5-turbo` — סינון מהיר ואפקטיבי (עד כ־350 טוקנים סך הכול) |
| **Prompt בסיסי**         | `SYSTEM: Rank the following government-decision rows for relevance to the query. Return JSON {"ranked_ids":[...]} only. Use short reasoning internally, not in output.` |
| **Few-shot חיוניים**     | - דוגמה עם נושא "חינוך" → מדורג גבוה  
                           - דוגמה עם טווח תאריכים → שורות מחוץ לטווח מדורגות נמוך |
| **ביצועים**             | p95 latency ≤ 300ms עבור עד 50 שורות |
| **שגיאות**              | - JSON פלט לא תקין → fallback: שימוש בסדר המקורי לפי `rows[:limit]`, נרשם Warning בלוג |
| **טלמטריה**             | - `avg_rank_distance` (השוואה בין מיקום קודם ואחרי דירוג)  
                           - `ranker_latency_ms`  
                           - `ranker_tokens` |
| **אבטחה**               | - אין גישת כתיבה/קריאה למסד  
                           - אין מידע אישי בשדות  
                           - נשמר רק `decision_title` בלוגים (redacted) |
| **בדיקות אוטומטיות**    | - החלטת "חינוך מיוחד" מדורגת ב־Top-3  
                           - שמירה על הגבלת תוצאות (`limit ≤ 10`)  
                           - JSON חוקי ותקני |
| **תלויות**              | OpenAI SDK ≥ 1.5  
                           prompt מאוחסן תחת `ranker_v1.md` ב־Git |
| **בעלים**               | Data-Science Lead  
                           Search Engineer  
                           Product PM — CECI-AI |

---

### זרימת QUERY מלאה (כולל Ranker):
משתמש  
→ `0_REWRITE_BOT`  
→ `1_INTENT_BOT`  
→ `2Q_SQL_GEN_BOT`  
→ `SQL DB`  
→ `3Q_RANKER_BOT`  
→ `4_FORMATTER`  
→ חזרה למשתמש
