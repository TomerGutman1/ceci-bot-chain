## מפרט מפורט – 2E_EVALUATOR_BOT

("Decision Evaluator" — שלב 2E במסלול EVAL)

| קטגוריה                  | פרטים                                                                                                                                                                                                                                                                                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ייעוד עסקי**           | לספק ניתוח איכותני, תמציתי ומושכל של החלטה אחת או קבוצה קטנה (עד 10), בהתאם לקריטריונים קבועים כגון אופרטיביות, רמת השפעה, גופים מעורבים וסיכון משפטי. |
| **קלט נכנס**             | **מקור:** `2X_CTX_ROUTER_BOT` (או לעיתים נדירות `1_INTENT_BOT` אם המשתמש סיפק מספר החלטה ישירות)  
                           **פורמט:**  
                           ```json
                           {
                             "decision_objects": [
                               {
                                 "id": 267,
                                 "decision_date": "1999-12-01",
                                 "decision_title": "שילוב תלמידים…",
                                 "summary": "אושרה תוכנית…",
                                 "decision_content": "בהתאם לסעיף 66…",
                                 "operativity": "דקלרטיבית",
                                 "tags_policy_area": "חינוך",
                                 "tags_government_body": "הממשלה"
                               }
                             ],
                             "analysis_type": "default"
                           }
                           ``` |
| **פלט יוצא**             | **יעד:** `4_FORMATTER`  
                           **פורמט:** JSON אחיד לצורך עיבוד עיצובי בהמשך:  
                           ```json
                           {
                             "analysis": [
                               {
                                 "id": 267,
                                 "score_overall": 0.78,
                                 "strengths": ["היקף לאומי רחב"],
                                 "weaknesses": ["חוסר תקצוב מפורש"],
                                 "operativity": "דקלרטיבית",
                                 "impact_level": "בינוני"
                               }
                             ]
                           }
                           ``` |
| **תחומי אחריות (Do)**   | - קריאה של `decision_content` או `summary`  
                           - חישוב ציונים לפי משקלות מוגדרים בפרומפט  
                           - תמיכה במספר החלטות (עד 10)  
                           - כיבוד פרמטר `analysis_type` (כגון `"swot"`, `"risk_only"`) |
| **גבולות (Don’t)**      | - לא ניגש למסד הנתונים  
                           - לא משנה את כוונת השאלה  
                           - לא מחזיר Markdown — רק JSON תקני |
| **מודל GPT מומלץ**       | `gpt-4-turbo` — בעל יכולת קריאה של מסמכים ארוכים, עמידות ודיוק |
| **Prompt בסיסי**         | `SYSTEM: You are an expert policy analyst… Receive JSON {decision_objects, analysis_type}. Return JSON {analysis:[…]} with fields: score_overall 0-1, strengths[], weaknesses[], operativity, impact_level. No extra keys.` |
| **Few-shot חיוניים**     | - החלטה אופרטיבית עם חוזקות וחולשות  
                           - החלטה דקלרטיבית עם השפעה נמוכה  
                           - ניתוח מסוג `"risk_only"` שמחזיר רק `weaknesses` |
| **ביצועים**             | השהיית p95 ≤ 700ms עבור עד 5 החלטות  
                           עד 4000 טוקנים סך הכל (קלט + פלט) |
| **שגיאות**              | - פלט JSON לא חוקי → ניסיון תיקון אוטומטי (regex)  
                           - אם נכשל → לוג שגיאה + הודעה מערכתית ל־Formatter |
| **טלמטריה**             | - `avg_score_overall`  
                           - `analysis_latency_ms`  
                           - `analysis_tokens` |
| **אבטחה**               | - אין מידע אישי מזוהה לרוב, אך מסיר טלפונים/מיילים אם קיימים  
                           - הגבלת קצב: עד 10 ניתוחים כבדים לדקה |
| **בדיקות אוטומטיות**    | - תקינות מלאה של JSON  
                           - `score_overall` בתחום [0,1]  
                           - קריאות חוזרות לא מחזירות תובנות סותרות (סטייה ≤ ±0.1) |
| **תלויות**              | OpenAI SDK ≥ 1.5  
                           prompt מאוחסן תחת `evaluator_v1.md` ב־Git |
| **בעלים**               | Policy-AI Lead  
                           Applied Scientist  
                           Product PM — CECI-AI |

---

### זרימת EVAL טיפוסית:
משתמש מבקש ניתוח ("נתח את הראשונה")  
→ `0_REWRITE_BOT`  
→ `1_INTENT_BOT` עם `ANALYSIS`  
→ `2X_CTX_ROUTER_BOT` מחלץ את `decision_id=345`  
→ `2E_EVALUATOR_BOT` מבצע ניתוח  
→ `4_FORMATTER` מחזיר תשובת Markdown  
→ חזרה למשתמש
