## 🧩 סיכום End-to-End לפי סוג כוונה

| 🔢 סוג כוונה       | 🧭 זיהוי INTENT                  | 🧱 שכבות מופעלות                                                                                  | 📝 פלט לדוגמה (Markdown)                                                                                                         |
|--------------------|----------------------------------|----------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| DATA_QUERY         | החלטות לפי נושא/תאריך/מספר     | 0_REWRITE_BOT → 1_INTENT_BOT → 2Q_SQL_GEN_BOT → SQL DB → 3Q_RANKER_BOT → 4_FORMATTER              | 🏛️ החלטת ממשלה מס' 345 + תקציר                                                                                                  |
| DATA_QUERY + full  | תוכן מלא של החלטה               | 0 → 1 → 2Q → SQL DB (כולל `decision_content`) → 4_FORMATTER                                       | 🏛️ החלטת ממשלה מס' 2081 + תקציר + **תוכן מלא של ההחלטה:** …                                                                  |
| ANALYSIS           | ניתוח איכותני של החלטה          | 0 → 1 (ANALYSIS) → 2X_CTX_ROUTER_BOT → SQL DB → 2E_EVALUATOR_BOT → 4_FORMATTER                     | 📊 ניתוח החלטה מס' 267: ציון, חוזקות, חולשות                                                                                   |
| RESULT_REF         | הפניה להחלטה קודמת בשיחה       | 0 → 1 (RESULT_REF) → 2X_CTX_ROUTER_BOT → 2Q_SQL_GEN_BOT → SQL DB → 4_FORMATTER                    | 🏛️ החלטה קודמת לפי אינדקס, כולל תוכן מלא                                                                                       |
| UNCLEAR → CLARIFY  | שאלה עמומה ("חינוך?", "תחבורה") | 0 → 1 (UNCLEAR) → 2C_CLARIFY_BOT                                                                  | ❓ "לא הבנתי למה אתה מתכוון ב'תחבורה' — האם הכוונה לתחבורה ציבורית / תשתיות / חקיקה?"                                      |



בהתאם לכל המפרטים, הנה המחשת **End-to-End מלאה** – מ־שאלה חופשית של משתמש ועד לתשובת צ'אט בפורמט Markdown. התהליך עובר בכל שכבות הפייפליין שהוגדרו:

---

## 🔁 End-to-End Flow: JSON to Final Markdown (CECI-AI)

### 🧑 קלט משתמש:

```text
תראה לי החלטות על תחבורה ציבורית בין 2010 ל־2015
```

---

### 0\_REWRITE\_BOT

🔧 מתקן ניסוח ומחזיר:

```json
{
  "clean_query": "הצג החלטות בנושא תחבורה ציבורית בין השנים 2010 ל-2015"
}
```

---

### 1\_INTENT\_BOT

🧠 מזהה כוונה ופרמטרים:

```json
{
  "intent": "DATA_QUERY",
  "params": {
    "topic_free": "תחבורה ציבורית",
    "date_from": "2010-01-01",
    "date_to": "2015-12-31",
    "limit": 50
  },
  "confidence": 0.94
}
```

---

### 2Q\_SQL\_GEN\_BOT

🧮 ממיר ל־SQL מאובטח:

```json
{
  "sql": "SELECT id, decision_date, decision_title, summary, tags_policy_area FROM israeli_government_decisions WHERE tags_policy_area ILIKE $1 AND decision_date BETWEEN $2 AND $3 LIMIT 50",
  "params": ["%תחבורה ציבורית%", "2010-01-01", "2015-12-31"]
}
```

---

### SQL DB (via Supabase)

📤 מחזיר תוצאות:

```json
{
  "clean_query": "הצג החלטות בנושא תחבורה ציבורית בין השנים 2010 ל-2015",
  "rows": [
    {
      "id": 345,
      "decision_title": "קידום רפורמה בתחבורה ציבורית",
      "summary": "הממשלה אישרה תוכנית לשיפור קווי האוטובוס...",
      "tags_policy_area": "תחבורה ציבורית",
      "decision_date": "2012-05-14"
    },
    {
      "id": 292,
      "decision_title": "שדרוג תחנות מרכזיות",
      "summary": "הוחלט לשדרג תשתיות תחבורה...",
      "tags_policy_area": "תחבורה ציבורית",
      "decision_date": "2013-10-02"
    }
    // ...עוד שורות
  ]
}
```

---

### 3Q\_RANKER\_BOT

📊 מדרג לפי רלוונטיות:

```json
{
  "ranked_ids": [345, 292]
}
```

---

### 4\_FORMATTER

🎨 יוצר את תשובת הצ'אט הסופית בפורמט Markdown:

```markdown
🏛️ החלטת ממשלה מס' 345  
📅 תאריך: 2012-05-14  
🏷️ תחום מדיניות: תחבורה ציבורית  
📝 תקציר: הממשלה אישרה תוכנית לשיפור קווי האוטובוס...

🏛️ החלטת ממשלה מס' 292  
📅 תאריך: 2013-10-02  
🏷️ תחום מדיניות: תחבורה ציבורית  
📝 תקציר: הוחלט לשדרג תשתיות תחבורה...
```

---

### 🔚 תוצאה למשתמש:

**המשתמש מקבל בצ'אט תשובה מסודרת עם כרטיסים לכל החלטה**, על פי דירוג הרלוונטיות, בפורמט אחיד ואינפורמטיבי.

---


הנה המחשת **End-to-End מלאה** לתרחיש שבו המשתמש מבקש תוכן מלא של החלטה מסוימת — לדוגמה:

> **"תן לי את התוכן המלא של החלטה 2081 מממשלת 37"**

---

## 🔁 End-to-End: בקשת תוכן מלא (FULLCONTENT)

---

### 🧑 קלט משתמש:

```text
תן לי את התוכן המלא של החלטה 2081 מממשלת 37
```

---

### 0\_REWRITE\_BOT

🔧 מתקן ניסוח:

```json
{
  "clean_query": "הצג את התוכן המלא של החלטה מספר 2081 מהממשלה ה-37"
}
```

---

### 1\_INTENT\_BOT

🧠 מזהה כוונה ופרמטרים:

```json
{
  "intent": "DATA_QUERY",
  "params": {
    "decision_number": 2081,
    "government_number": 37,
    "full_content": true
  },
  "confidence": 0.97
}
```

---

### 2Q\_SQL\_GEN\_BOT

🧮 בונה SQL בהתאם ל־`full_content=true`:

```json
{
  "sql": "SELECT id, decision_date, decision_number, government_number, decision_title, summary, decision_content, decision_url FROM israeli_government_decisions WHERE decision_number=$1 AND government_number=$2 LIMIT 1",
  "params": [2081, 37]
}
```

---

### SQL DB (via Supabase)

📤 מחזיר שורת החלטה מלאה:

```json
{
  "raw_rows": [
    {
      "id": 1123,
      "decision_date": "2021-03-15",
      "decision_number": 2081,
      "government_number": 37,
      "decision_title": "שיפור נגישות לאנשים עם מוגבלות",
      "summary": "הממשלה החליטה לתקצב הנגשת מבני ציבור...",
      "decision_content": "בהתאם להמלצות ועדת זליכה, יוקצו 50 מיליון ש״ח לנגישות... סעיפים א–ד מפרטים את סוגי המוסדות המעורבים והלוחות זמנים.",
      "decision_url": "https://gov.il/decision/2081"
    }
  ],
  "full_content": true
}
```

---

### 4\_FORMATTER

🎨 מעצב תשובה למשתמש עם "תוכן מלא":

```markdown
🏛️ החלטת ממשלה מס' 2081  
🔢 מספר החלטה: 2081  
🏢 ממשלה: 37  
📅 תאריך: 2021-03-15  
🏷️ תחום מדיניות: לא צוין  
📝 תקציר: הממשלה החליטה לתקצב הנגשת מבני ציבור...  
🔗 קישור להחלטה: [לצפייה](https://gov.il/decision/2081)

**תוכן מלא של ההחלטה:**  
בהתאם להמלצות ועדת זליכה, יוקצו 50 מיליון ש״ח לנגישות... סעיפים א–ד מפרטים את סוגי המוסדות המעורבים והלוחות זמנים.
```

---

### ✅ תוצאה למשתמש:

המשתמש מקבל בצ'אט תשובה עשירה הכוללת גם סיכום וגם את התוכן המלא של ההחלטה – בפורמט ברור וידידותי.

---




הנה המחשת **End-to-End מלאה** עבור שאילתה מסוג ניתוח איכותני (`ANALYSIS`) — לדוגמה:

> **"תנתח לי את ההחלטה על שילוב תלמידים עם צרכים מיוחדים"**

---

## 🔁 End-to-End: בקשת ניתוח (`ANALYSIS`)

---

### 🧑 קלט משתמש:

```text
תנתח לי את ההחלטה על שילוב תלמידים עם צרכים מיוחדים
```

---

### 0\_REWRITE\_BOT

🔧 מתקן ניסוח:

```json
{
  "clean_query": "נתח את ההחלטה בנושא שילוב תלמידים עם צרכים מיוחדים"
}
```

---

### 1\_INTENT\_BOT

🧠 מזהה כוונה ופרמטרים:

```json
{
  "intent": "ANALYSIS",
  "params": {
    "topic_free": "שילוב תלמידים עם צרכים מיוחדים",
    "limit": 1
  },
  "confidence": 0.91
}
```

---

### 2X\_CTX\_ROUTER\_BOT

🔄 מאתר את ההחלטה המתאימה ביותר (מתוך זיכרון שיחה / שליפה לפי נושא):

```json
{
  "resolved": true,
  "decision_ids": [267],
  "next_action": "EVALUATE"
}
```

---

### SQL DB

📤 שולף את פרטי ההחלטה לצורך ניתוח:

```json
{
  "decision_objects": [
    {
      "id": 267,
      "decision_date": "1999-12-01",
      "decision_title": "שילוב תלמידים עם צרכים מיוחדים במערכת החינוך",
      "summary": "הממשלה אישרה תוכנית חינוכית משולבת...",
      "decision_content": "בהתאם לסעיף 66 לחוק החינוך המיוחד...",
      "operativity": "דקלרטיבית",
      "tags_policy_area": "חינוך",
      "tags_government_body": "הממשלה"
    }
  ],
  "analysis_type": "default"
}
```

---

### 2E\_EVALUATOR\_BOT

📈 מבצע ניתוח איכותני לפי קריטריונים מוגדרים:

```json
{
  "analysis": [
    {
      "id": 267,
      "score_overall": 0.78,
      "strengths": ["היקף לאומי רחב", "התייחסות מפורטת לשילוב בכיתה"],
      "weaknesses": ["אין תקצוב מפורש", "היעדר לוחות זמנים"],
      "operativity": "דקלרטיבית",
      "impact_level": "בינוני"
    }
  ]
}
```

---

### 4\_FORMATTER

🎨 מעבד את פלט הניתוח להודעת Markdown:

```markdown
📊 ניתוח החלטה מס' 267: שילוב תלמידים עם צרכים מיוחדים

- 🔢 ציון כולל: 0.78
- 🏷️ אופרטיביות: דקלרטיבית
- 📈 רמת השפעה: בינוני

**✔️ חוזקות:**  
• היקף לאומי רחב  
• התייחסות מפורטת לשילוב בכיתה

**⚠️ חולשות:**  
• אין תקצוב מפורש  
• היעדר לוחות זמנים
```

---

### ✅ תוצאה למשתמש:

המשתמש מקבל סיכום אנליטי מקצועי עם הדגשת חוזקות, חולשות, ציון כללי וסיווגים — בצורה נגישה וקריאה.

---

הנה המחשה **End-to-End מלאה** עבור תרחיש שבו המשתמש מתייחס להחלטה קודמת בשיחה —
כלומר, `RESULT_REF` עם אינדקס (כמו: **"תן לי את התוכן המלא של השנייה"**):

---

## 🔁 End-to-End: הפניה להחלטה קודמת (`RESULT_REF`)

---

### 🧑 קלט משתמש:

```text
תן לי את התוכן המלא של השנייה
```

---

### 0\_REWRITE\_BOT

🔧 מתקן ניסוח:

```json
{
  "clean_query": "הצג לי את התוכן המלא של ההחלטה השנייה"
}
```

---

### 1\_INTENT\_BOT

🧠 מזהה כוונה מסוג `RESULT_REF`:

```json
{
  "intent": "RESULT_REF",
  "params": {
    "index_in_previous": 2,
    "request_full_content": true
  },
  "confidence": 0.92
}
```

---

### 2X\_CTX\_ROUTER\_BOT

🔄 ממפה את אינדקס 2 לרשימת ה־IDs של ההחלטות מהשיחה הקודמת:

```json
{
  "resolved": true,
  "decision_ids": [292],
  "next_action": "SQL"
}
```

---

### 2Q\_SQL\_GEN\_BOT

🧮 מייצר שאילתת SQL לתוכן מלא של ההחלטה עם ID 292:

```json
{
  "sql": "SELECT id, decision_title, summary, decision_content, decision_url FROM israeli_government_decisions WHERE id=$1 LIMIT 1",
  "params": [292]
}
```

---

### SQL DB (Supabase)

📤 שולף את תוכן ההחלטה:

```json
{
  "raw_rows": [
    {
      "id": 292,
      "decision_title": "שדרוג תחנות מרכזיות",
      "summary": "הוחלט לשדרג תשתיות תחבורה ציבורית ב־5 ערים גדולות.",
      "decision_content": "בהתאם להחלטה, יוקצו 200 מיליון ש״ח לשיפוץ תחנות מרכזיות...",
      "decision_url": "https://gov.il/decision/292"
    }
  ],
  "full_content": true
}
```

---

### 4\_FORMATTER

🎨 מעצב תשובה בפורמט Markdown עם תוכן מלא:

```markdown
🏛️ החלטת ממשלה מס' 292  
🔢 מספר החלטה: 292  
📅 תאריך: לא צוין  
🏷️ תחום מדיניות: לא צוין  
📝 תקציר: הוחלט לשדרג תשתיות תחבורה ציבורית ב־5 ערים גדולות.  
🔗 קישור להחלטה: [לצפייה](https://gov.il/decision/292)

**תוכן מלא של ההחלטה:**  
בהתאם להחלטה, יוקצו 200 מיליון ש״ח לשיפוץ תחנות מרכזיות...
```

---

### ✅ תוצאה למשתמש:

המשתמש מקבל את **התוכן המלא של ההחלטה השנייה** מהשיחה הקודמת, בלי צורך לציין את מספר ההחלטה.

---



הנה המחשה **End-to-End מלאה** לתרחיש שבו המשתמש שואל שאלה לא ברורה — כלומר,
`UNCLEAR` → מופעלת שכבת ההבהרה `2C_CLARIFY_BOT` שמחזירה שאלה ממוקדת.

---

## 🔁 End-to-End: שאלה לא ברורה (`UNCLEAR` → `CLARIFY`)

---

### 🧑 קלט משתמש:

```text
תחבורה?
```

---

### 0\_REWRITE\_BOT

🔧 מתקן ניסוח מינימלי (אין מה לתקן):

```json
{
  "clean_query": "תחבורה?"
}
```

---

### 1\_INTENT\_BOT

🧠 מזהה שהשאלה אינה ברורה, confidence נמוך:

```json
{
  "intent": "UNCLEAR",
  "params": {},
  "confidence": 0.43
}
```

---

### 2C\_CLARIFY\_BOT

❓ שואל שאלה מחדדת:

```json
{
  "reason": "unclear_intent",
  "clean_query": "תחבורה?"
}
```

🔁 מחזיר למשתמש שאלה בעברית טבעית:

```text
לא הבנתי למה אתה מתכוון ב"תחבורה" — האם אתה מחפש החלטות על תחבורה ציבורית, תשתיות תחבורה או נושאים אחרים?
```

---

### 🧑 תשובת משתמש:

```text
תחבורה ציבורית בין 2010 ל־2015
```

---

🔁 חוזר ל־`0_REWRITE_BOT` → הפייפליין מתחיל מחדש עם ניסוח ברור יותר.

---

### ✅ תוצאה למשתמש:

המערכת שומרת על שיחה נקייה, מבקשת הבהרה במקום לנחש או להחזיר תשובה שגויה,
וממשיכה את התהליך ברגע שהמשתמש מדייק את כוונתו.

---

