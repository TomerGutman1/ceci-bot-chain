## מפרט מלא – 0_REWRITE_BOT

("Rewriter / Normalizer" — שלב 0 במסלול MAIN)

| קטגוריה                  | פרטים                                                                                                                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ייעוד עסקי**           | להפוך כל קלט חופשי לעברית תקנית, קצרה ואחידה, כך ששכבות ההמשך יקבלו שאילתה עקבית וקלת-עיבוד.                                                                                                           |
| **קלט נכנס**             | **מקור:** המשתמש ישירות.  
                           **פורמט:** משפט/שאלה בעברית טבעית — עלול להכיל שגיאות כתיב, סלנג, תאריכים חלקיים, טווחים (למשל "מ-95 עד 2010"), קיצורים ("החלט'"), וסימני פיסוק שרירותיים.  
                           **הערה:** הקלט **אינו** SQL. |
| **פלט יוצא**             | **יעד:** `1_INTENT_BOT`.  
                           **פורמט:** אובייקט JSON יחיד:  
                           `json { "clean_query": "<שאלה מנורמלת בעברית תקנית>" }`  
                           נשאר בעברית טבעית, **לא** SQL, ללא מידע נוסף. |
| **תחומי אחריות (Do)**   | - תיקון שגיאות כתיב ותחביר  
                           - הרחבת קיצורים נפוצים  
                           - נרמול טווחי תאריכים למבנה ISO `YYYY-MM-DD`  
                           - הסרת תווים לא רלוונטיים (למשל, אמוג'ים או סימני קישוט)  
                           - שמירה על המשמעות המקורית |
| **גבולות (Don’t)**      | - לא מתרגם לאנגלית  
                           - לא מוסיף מידע חדש  
                           - לא מסווג כוונה  
                           - לא מחזיר תשובה למשתמש |
| **מודל GPT מומלץ**       | `gpt-3.5-turbo` — ניסוח קל ומהיר (בערך 20–60 טוקנים) |
| **Prompt בסיסי**         | `text SYSTEM: תקן ניסוחים עבריים לשפה תקנית; החזר JSON {"clean_query": "..."} בלבד. USER: <השאלה>` |
| **Few-shot חיוניים**     | דוגמאות לשגיאות כתיב (למשל "החלתה"), טווחי שנים ("מ-95 עד 99"), סלנג, וסימני שאלה עודפים. |
| **ביצועים**             | השהיית p95 ≤ 200ms  
                           קלט ≤ 150 טוקנים  
                           פלט ≤ 50 טוקנים |
| **שגיאות**              | אם הפלט אינו JSON תקין:  
                           לוג שגיאה + החזרת הקלט תחת `clean_query`  
                           והוספת flag `"rewrite_error": true` |
| **טלמטריה**             | - מספר תווים שנחסכו (`rewrite_chars_saved`)  
                           - זמן תגובה (`rewrite_latency_ms`)  
                           - שיעור שגיאות (`rewrite_error_rate`) |
| **אבטחה**               | הסתרת מידע אישי לפני רישום ביומן  
                           הגבלת קצב ל־50 בקשות לדקה לכל כתובת IP |
| **בדיקות**              | - תיקון שגיאות כתיב  
                           - המרת טווחי תאריכים לפורמט ISO (למשל: "מ-95" → "1995-01-01")  
                           - בדיקת שמירה על משמעות מקורית (Δ-משמעות ≤ 0.1) |
| **תלויות**              | OpenAI SDK ≥ 1.5  
                           Node 18  
                           TypeScript 5  
                           Prompt שמור ב־Git תחת `rewriter_v1` |
| **בעלים**               | AI Lead  
                           NLP Engineer  
                           Product Manager – CECI-AI |

---

### הזרימה:
משתמש → 0_REWRITE_BOT (קלט בשפה טבעית) → JSON עם `clean_query` → 1_INTENT_BOT
