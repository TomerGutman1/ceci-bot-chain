## מפרט מפורט – 2C_CLARIFY_BOT

("Clarifier" — שלב 2C במסלול CLARIFY)

| קטגוריה                  | פרטים                                                                                                                                                                                                                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ייעוד עסקי**           | כאשר `1_INTENT_BOT` או `2X_CTX_ROUTER_BOT` אינם מצליחים להבין את כוונת המשתמש בוודאות, השכבה מחזירה שאלה אחת קצרה וברורה למשתמש, שמצמצמת את הערפול ומאפשרת המשך תקין של הפייפליין. |
| **קלט נכנס**             | **מקורות:**  
                           - `1_INTENT_BOT` אם `intent="UNCLEAR"` או `confidence < 0.7`  
                           - `2X_CTX_ROUTER_BOT` אם `resolved:false`  
                           **פורמט דוגמה:**  
                           ```json
                           { "reason": "unclear_intent", "clean_query": "חינוך?" }
                           ```  
                           או  
                           ```json
                           { "reason": "no_context_match", "index_in_previous": 5 }
                           ``` |
| **פלט יוצא**             | **יעד:** המשתמש (ישירות בצ'אט)  
                           **פורמט:** טקסט עברית טבעית, שאלה אחת קצרה בגוף שני  
                           **דוגמאות:**  
                           - "לא הבנתי למה אתה מתכוון ב'חינוך?' – האם תרצה החלטות בנושא חינוך בסיסי או מיוחד?"  
                           - "לא מצאתי 'השלישית' מתוך התוצאות האחרונות: האם תוכל לציין מספר החלטה או טווח תאריכים?" |
| **תחומי אחריות (Do)**   | - ניסוח שאלה אחת בלבד  
                           - פנייה בגוף שני  
                           - הצעת דוגמאות/כפתורים כאשר מתאים  
                           - שמירה על `session_cache` פעיל (לא מתאפס) |
| **גבולות (Don’t)**      | - לא מסביר את מנגנון הפייפליין  
                           - לא מספק תשובה למשתמש  
                           - לא מנחש את הכוונה המקורית של המשתמש |
| **מודל GPT מומלץ**       | `gpt-3.5-turbo` — מענה מהיר, חד וקצר, עם עלות נמוכה |
| **Prompt בסיסי**         | `SYSTEM: You are a concise Hebrew assistant. The user query was ambiguous. Ask ONE short clarification question in Hebrew. Do NOT answer the original query.` |
| **Few-shot חיוניים**     | - שאילת נושא כללי: "תחבורה?" → "לאיזה תחום בתחבורה..."  
                           - חוסר בטווח תאריכים  
                           - אינדקס מחוץ לטווח (למשל 5 מתוך 3 תוצאות) |
| **ביצועים**             | p95 latency ≤ 120ms  
                           קלט ≤ 60 טוקנים  
                           פלט ≤ 40 טוקנים |
| **שגיאות**              | - קלט חסר שדה `reason` → שאלה כללית: "תוכל להבהיר למה אתה מתכוון?" |
| **טלמטריה**             | - `clarify_invocations`  
                           - `clarify_response_len`  
                           - `clarify_resolution_rate` (שיעור המשך זרימה מוצלח לאחר ההבהרה) |
| **אבטחה**               | - הסרת מידע אישי מהשאלה המוחזרת  
                           - שמירת תקציר בלבד ביומנים, לא מלל מלא של המשתמש |
| **בדיקות אוטומטיות**    | - וידוא שהתשובה היא שאלה בלבד  
                           - פלט ≤ 40 טוקנים  
                           - כתיבה בעברית בגוף שני |
| **תלויות**              | OpenAI SDK ≥ 1.5  
                           prompt מאוחסן תחת `clarify_v1.md` ב־Git |
| **בעלים**               | Conversation UX Lead  
                           Prompt Engineer  
                           Product PM — CECI-AI |

---

### זרימת הבהרה טיפוסית:
1. משתמש שואל: "תחבורה?"  
2. `0_REWRITE_BOT` מתקן ניסוח  
3. `1_INTENT_BOT` מזהה כוונה לא ברורה  
4. `2C_CLARIFY_BOT` שואל: "לאיזה תחום בתחבורה התכוונת? תחבורה ציבורית / תשתיות / חקיקה תחבורתית?"  
5. משתמש עונה  
6. חוזר ל־`0_REWRITE_BOT` להמשך הפייפליין
